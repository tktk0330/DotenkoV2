# DotenkoV2 - 確定ゲームルール仕様書（フェーズ1）

*最終更新: 2024年12月*

## フェーズ1の目標
**基本的などてんこ機能の完成**
- 追加機能や磨き上げはフェーズ2で実装
- 現段階では基本機能に集中
- **重要**: チャレンジゾーン、しょてんこ・バースト、スコア確定イベント、中間結果画面も全てフェーズ1で実装

## 基本仕様

### ゲーム概要
- **ゲーム名**: ドテンコ（Dotenco）
- **プレイヤー数**: 2-5人
- **使用カード**: トランプ52枚 + ジョーカー0-4枚（設定可能）
- **勝利条件**: 場のカードと手札の合計が一致した時に「どてんこ」宣言

### 基本ルール
- **手札**: 各プレイヤーに2枚ずつ配布（ラウンド開始時）
- **ターン制**: 時計回り
- **どてんこ宣言**: 条件が揃えばどのタイミングでも宣言可能（リアルタイム）
- **手札上限**: 7枚（7枚でパスすると負け、出せれば続行可能）

## カード出しルール

### 出せるカードのパターン
1. **同じ数字**: 場→スペード13, 出す→ハート13
2. **同じ数字で複数**: 場→スペード13, 出す→ハート13+ダイヤ13
3. **同じスート**: 場→スペード13, 出す→スペード5
4. **同じスートで複数**: 場→スペード13, 出す→スペード5+ハート5
   - **注意**: 場と同じスートが最初に選択されている必要がある
5. **合計が同じ**: 場→13, 出す→4+9（スート関係なし）

### ジョーカーの効果
- **スート**: 全てのスートに対応
- **数値**: -1, 0, 1のいずれかとして計算可能
- **複数ジョーカー**: それぞれ独立して-1/0/1を選択可能
- **例**: 手札→ジョーカー+4+2の時、合計は5, 6, 7と考えられる

## ゲーム進行

### ゲーム開始
1. カード配布（各プレイヤー2枚）
2. 5秒カウントダウン開始
3. 山札の一番上をめくる
4. 早い者勝ちでカードを出す
5. 最初に出せたプレイヤーから時計回りでターン開始

### プレイヤーターン
- **パターン1**: カードを出す → ターン終了
- **パターン2**: デッキから引く → カードを出す → ターン終了
- **パターン3**: デッキから引く → パス → ターン終了
- **パターン4**: カードを出せるがデッキから引く → カードを出す → ターン終了
- **パターン5**: カードを出せるがデッキから引く → パス → ターン終了

### 山札管理
- **山札切れ**: 場の一番上を残してシャッフル
- **ラウンド終了**: 全カードをデッキに回収してシャッフル

## どてんこシステム

### どてんこ判定
- **条件**: 場のカードと手札の合計が一致
- **ジョーカー含む**: どれか1つのパターンでも一致すれば可能
- **宣言タイミング**: カード出し直後、デッキから引いた直後でも即座に宣言可能

### どてんこ宣言
- **UI**: 条件を満たした瞬間にボタン表示
- **確認ダイアログ**: 不要
- **早い者勝ち**: 複数プレイヤーが同時に条件を満たした場合、最初に宣言した人が優先

## リベンジシステム

### リベンジ発生条件
- どてんこ宣言後、他にもどてんこ条件を満たすプレイヤーがいる場合

### リベンジ処理
- **待機時間**: 
  - BOT対戦: 3秒以内
  - オンライン対戦: 5秒以内（フェーズ2）
- **待機中表示**: 「リベンジ可能」表示
- **勝敗変更**: 最初にどてんこした人が負け、リベンジした人が勝ち
- **複数リベンジ**: 連鎖可能、最後にリベンジした人が勝者
- **複数回処理**: リベンジ後さらに5秒待機 → チャレンジゾーンへ

## チャレンジゾーン

### 発生条件
- 全てのプレイヤーがどてんこ宣言を完了した時点

### 参加条件
- 手札合計 < 場のカード数字

### 進行ルール
- **順序**: どてんこした次の人から時計回り
- **手札制限**: チャレンジ中は手札無制限
- **ジョーカー**: 自動選択でどてんこになるように最適化
- **山札切れ**: 場のカードをシャッフルして継続

### 終了条件
- どてんこ・リベンジした人以外が全員手札合計 > 場の数字

### 勝敗
- **勝者**: 最後にリベンジした人
- **敗者**: 直前にリベンジした人

## 特殊ルール

### しょてんこ（SHOTENKO）
- **発生条件**: 最初に山札から捲られたカードと手札の合計が一致
- **勝敗**: 勝者1人 vs 敗者全員
- **スコア**: 勝者が全員からスコアを受け取る
- **チャレンジゾーン**: 発生する

### バースト（Burst）
- **発生条件**: 手札7枚でパス
- **勝敗**: 敗者1人 vs 勝者全員
- **スコア**: 敗者が全員にスコアを支払う
- **チャレンジゾーン**: スキップして直接スコア確定

## スコア計算システム

### 基本計算式
```
ラウンドスコア = 初期レート × 上昇レート × デッキの裏の数字
```

### 初期レート
- GameSetting.gameRateで設定

### 上昇レート倍増条件
1. **ゲーム開始時**: 1、2、ジョーカーが出た場合（連続確認）
2. **ゲーム中**: 同じ数字がGameSetting.upRate回連続で出た場合
3. **ゲーム終了時**: デッキの裏が1、2、ジョーカーの場合（連続確認）

### デッキの裏
- 山札の一番下のカードの数字

### 特殊カード効果（スコア確定時）
- **1、2、ジョーカー**: 50倍
- **ダイヤ3**: 30倍
- **黒3（スペード・クラブ）**: 勝敗逆転（倍率ではない）
- **ハート3**: 通常の3倍

## UI/UX仕様

### プレイヤー配置
- **画面下**: 常に自分
- **2人**: 上（対面）
- **3人**: 左右
- **4人**: 上、左右
- **5人**: 上2人、左右（重ならない間隔）

### カード操作
- **選択**: タップでY軸移動による選択表示
- **選択解除**: 選択したカードを再度タップで解除可能（実装済み）
- **カード出し**: 選択カード + 出すボタンで確定
- **不正操作**: 出せないカードの場合アラート表示（仮文言で実装）

### ゲーム状態表示
- **現在のターン**: プレイヤーアイコンの背景色を明るくする
- **手札枚数**: 他プレイヤーの手札枚数をアイコンの上に数字のみで表示（実装済み）
- **山札残り枚数**: デッキの上に数字のみで表示（要実装）
- **ターン外操作**: どてんこ宣言はターン表示と関係なく可能

### ボタン表示
- **どてんこボタン**: 条件を満たした瞬間に表示
- **リベンジボタン**: 待機中に「リベンジ可能」表示

## BOTシステム（フェーズ1仕様）

### BOT思考時間
- **トータル**: 3秒以内
- **各行動**: カード出し、デッキから引く、パス全て同じ
- **人間らしい遅延**: 必要

### BOT判定精度（フェーズ1）
- **どてんこ宣言**: 見逃しなし（初期段階）
- **思考ロジック**: 基本的なロジックで実装
- **カード出し判定**: 同じ数字優先
- **デッキから引く判定**: ランダム
- **パス判定**: ランダム
- **対応人数**: 2-5人対応すべて実装
- **難易度設定**: なし（フェーズ2で検討）

## GameSetting設定項目

### 現在の設定値
- **roundCount**（ラウンド数）: デフォルト "5"
- **jokerCount**（ジョーカー枚数）: デフォルト "2"
- **gameRate**（ゲームレート）: デフォルト "1"
- **upRate**（重ねレートアップ）: デフォルト "3"
- **maxScore**（スコア上限）: デフォルト "1000"
- **deckCycle**（デッキサイクル）: デフォルト "3"

## 演出システム（フェーズ1）

### 必要な演出
- **デッキの裏確認**: 山札の一番下をめくる演出
- **特殊カード演出**: 
  - 1、2、ジョーカー: 同じ演出（簡単なエフェクト）
  - 黒3: 個別演出（簡単なエフェクト）
  - ダイヤ3: 個別演出（簡単なエフェクト）
- **どてんこ演出**: パチンコの当たりのようにDOTENKOの文字が派手に動く（アニメーション付き）
- **上昇レート演出**: 豪華な上昇アニメーション
- **連続確認**: 特別な処理なし
- **音響効果**: あり
- **演出時間**: MAX5秒

## 中間結果画面

### 表示内容
- 現在のプレイヤーの所持スコア
- そのラウンドで移動したスコア
- OKボタン（全員待機システム）

### 遷移
- OKボタンでゲーム画面に戻る
- 他プレイヤーの復帰を待機

## エラー・例外処理（フェーズ1）

### 同時操作
- 簡単なロック機構で順次処理

### ネットワーク（BOT対戦）
- Firebase接続エラー時は再接続を試行
- **リトライ**: 3回試行してダメならエラー画面表示（実装済み）

### 不正操作
- **不正カード出し**: 基本的なアラート表示

### アプリ復帰（BOT対戦）
- バックグラウンドから復帰時、ゲーム状態をそのまま継続

## 実装優先順序（フェーズ1）

1. **基本的なカード出し判定システム**
2. **どてんこ宣言システム**
3. **リベンジシステム**（段階的実装可能）
4. **チャレンジゾーンシステム**
5. **しょてんこ・バーストシステム**
6. **スコア計算システム**
7. **中間結果画面**
8. **BOT思考システム**

---

## フェーズ1で確定済み事項

### 実装範囲
- **チャレンジゾーン**: フェーズ1で実装
- **しょてんこ・バースト**: フェーズ1で実装
- **スコア確定イベント**: デッキの裏確認もフェーズ1で実装
- **中間結果画面**: フェーズ1で実装

### 演出レベル
- **どてんこ演出**: アニメーション付き
- **特殊カード演出**: 簡単なエフェクト
- **上昇レート演出**: 豪華なアニメーション
- **実装順序**: 指定なし

### エラーハンドリング
- **不正カード出し**: 基本的なアラート表示
- **同時操作**: 簡単なロック機構
- **ネットワークエラー**: 3回リトライ後エラー画面（実装済み）

### BOT実装
- **BOT思考**: 基本的なロジック
- **BOT行動**: 人間らしい遅延あり
- **BOT人数**: 2-5人対応すべて実装

### UI/UX
- **プレイヤー配置**: 5人対応必須
- **ターン表示**: プレイヤーアイコンの背景色を明るくする
- **手札枚数表示**: アイコンの上に数字のみ（実装済み）
- **山札残り枚数**: デッキの上に数字のみ（要実装）
- **アプリ復帰**: ゲーム状態継続

---

## フェーズ2で検討予定

### オンライン機能
- **復帰時同期処理**: 詳細例題が必要
- **BOT代走システム**: 切断時の処理

### BOT強化
- **見逃し確率**: 具体的な数値設定
- **難易度設定**: ユーザー選択可能

### 演出強化
- **アニメーション差し込み**: どてんこ演出の追加
- **カジノ風演出**: より豪華な演出

---
*フェーズ1: 基本機能完成を目標とする確定仕様書* 