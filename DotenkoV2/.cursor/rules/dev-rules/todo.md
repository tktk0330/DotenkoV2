# DotenkoV2 - タスク管理

## 現在の開発状況（2024年12月）

### 🔴 高優先度タスク

#### ゲーム機能実装（段階的実装）
- [x] **カード出し判定システム** ✅ **完了**
  - [x] 同じ数字判定
  - [x] 同じスート判定（最初のカードが場と同じスート必須）
  - [x] 合計値判定（スート関係なし）
  - [x] 複数カード組み合わせ判定
  - [x] 不正操作時のエラーメッセージ表示
  - [x] ジョーカー対応（-1, 0, 1の組み合わせ計算）

- [ ] **ジョーカーシステム**
  - [ ] ジョーカー選択機能（0-4枚）
  - [ ] ジョーカーの数値計算（-1, 0, 1）
  - [ ] 複数ジョーカーの独立計算
  - [ ] 全スート対応機能
  - [ ] 手札合計値計算（複数パターン対応）

- [ ] **どてんこ宣言システム** ← **次のステップ**
  - [ ] 場のカードと手札の合計値判定
  - [ ] どてんこ宣言UI（条件満たす時のみ表示）
  - [ ] 勝敗判定システム
  - [ ] リアルタイム宣言機能（ターン外でも可能）

- [ ] **リベンジシステム（段階的実装）**
  - [ ] どてんこ後の追加判定
  - [ ] リベンジ宣言UI
  - [ ] 複数リベンジ対応
  - [ ] 勝敗の動的変更処理

#### ゲーム進行システム
- [x] **ゲーム開始フロー** ✅ **完了**
  - [x] カード配布（各プレイヤー2枚）
  - [x] 5秒カウントダウン機能
  - [x] 山札めくり（早い者勝ち）
  - [x] ターン管理（時計回り）

- [x] **プレイヤーターンシステム** ✅ **完了**
  - [x] カード出し判定
  - [x] デッキからカード引く機能
  - [x] パス機能
  - [x] 手札上限管理（7枚）
  - [x] 山札切れ時のシャッフル（場の一番上を残す）
  - [ ] 負け判定（手札7枚でパス→ラウンド終了）

- [x] **山札管理システム** ✅ **完了**
  - [x] 山札切れ時のシャッフル（場の一番上を残す）
  - [x] デッキサイクル管理
  - [x] ラウンド終了時の全カード回収・シャッフル

#### スコア計算システム
- [ ] **レート計算機能**
  - [ ] 初期レート設定（GameSetting.gameRate）
  - [ ] 上昇レート計算（連続カード、特殊カード対応）
  - [ ] デッキの裏の数字取得（山札の一番下）
  - [ ] 最終スコア計算（初期×上昇×裏数字）

- [ ] **上昇レート倍増システム**
  - [ ] ゲーム開始時：1、2、ジョーカー判定（連続確認）
  - [ ] ゲーム中：同じ数字連続判定（GameSetting.upRate）
  - [ ] ゲーム終了時：デッキ裏の1、2、ジョーカー判定（連続確認）
  - [ ] 連続倍増処理

#### BOTシステム ← **実装優先順序8番目**
- [x] **BOT思考システム** ✅ **完了**
  - [x] 思考時間設定（最大3秒、最小0.5秒）
  - [x] カード出し判定AI（同じ数字優先）
  - [x] デッキから引く判定（ランダム）
  - [x] パス判定（ランダム）
  - [x] どてんこ宣言判定AI（見逃しなし）
  - [x] リベンジ宣言判定AI

### 🟡 中優先度タスク

#### チャレンジゾーンシステム（フェーズ1）
- [ ] **チャレンジゾーン発生条件**
  - [ ] 全プレイヤーのどてんこ宣言完了判定
  - [ ] 参加条件判定（手札合計 < 場のカード数字）

- [ ] **チャレンジゾーン進行**
  - [ ] どてんこした次の人から時計回り
  - [ ] 手札無制限システム
  - [ ] ジョーカー自動選択（どてんこ最適化）
  - [ ] 山札切れ時の場カードシャッフル

- [ ] **チャレンジゾーン終了**
  - [ ] 終了条件判定（全員手札合計 > 場の数字）
  - [ ] 最終勝者・敗者決定

#### しょてんこ・バーストシステム（フェーズ1）
- [ ] **しょてんこ（SHOTENKO）**
  - [ ] 最初のカードと手札合計一致判定
  - [ ] 勝者1人 vs 敗者全員のスコア計算
  - [ ] チャレンジゾーン発生処理

- [ ] **バースト（Burst）**
  - [ ] 手札7枚でパス判定
  - [ ] 敗者1人 vs 勝者全員のスコア計算
  - [ ] チャレンジゾーンスキップ処理

#### スコア確定イベント（フェーズ1）
- [ ] **デッキの裏確認**
  - [ ] 山札の一番下カード確認演出
  - [ ] 特殊カード連続確認処理
  - [ ] 特殊カード効果適用

- [ ] **特殊カード演出**
  - [ ] 1、2、ジョーカー演出（同じ）
  - [ ] 黒3演出（個別）
  - [ ] ダイヤ3演出（個別）

#### オンライン対戦システム（将来実装）
- [ ] **友人対戦機能**
  - [ ] 友人招待システム
  - [ ] ルーム作成・参加
  - [ ] リアルタイム同期

- [ ] **BOT代走システム**
  - [ ] 切断検知機能
  - [ ] BOT自動代理操作
  - [ ] 復帰時の操作権移譲
  - [ ] 状態同期機能

- [ ] **ネットワーク管理**
  - [ ] 自動再接続機能
  - [ ] 切断時の状態保存
  - [ ] ゲーム中断・再開機能
  - [ ] エラー回復処理

#### 追加機能
- [ ] **設定機能拡張**
  - [ ] 音響設定
  - [ ] 演出設定

- [ ] **チュートリアル**
  - [ ] ゲームルール説明
  - [ ] 操作方法説明

### ✅ 完了済みタスク

- [x] **プロジェクト初期化**
  - [x] SwiftUI + MVVM アーキテクチャ構築
  - [x] Firebase統合
  - [x] 基本画面構成

- [x] **基本ゲーム進行システム**
  - [x] 山札残り枚数表示
  - [x] 5秒カウントダウンシステム
  - [x] ターン管理システム（時計回り）
  - [x] プレイヤーアイコンのターン表示
  - [x] カード配布アニメーション
  - [x] 場札配置システム

- [x] **カード操作システム**
  - [x] カード選択/解除（タップでY軸移動）
  - [x] カード出し判定（5つのルール）
  - [x] ジョーカー対応（-1, 0, 1の組み合わせ）
  - [x] パス/カード引きシステム
  - [x] 山札再構築（場の一番上を残してシャッフル）

- [x] **UI/UX基盤**
  - [x] ボタン有効/無効制御
  - [x] プレイヤー配置（2-5人対応）
  - [x] カジノ風デザイン
  - [x] アニメーション付きカード移動

- [x] **BOT思考システム** ✅ **完了**
  - [x] ターン制でのBOT自動操作
  - [x] 思考時間ランダム化（0.5-3秒）
  - [x] カード出し優先度判定（同じ数字優先）
  - [x] デッキから引く/パス判定（ランダム）
  - [x] リアルタイムどてんこ宣言（見逃しなし）
  - [x] リベンジ宣言システム
  - [x] 人間らしい遅延処理

- [x] **最終結果画面** ✅ **新規完了**
  - [x] 順位表示システム（スコア順ソート）
  - [x] 豪華な色表現（金・銀・銅・青・紫）
  - [x] プレイヤー情報表示（アイコン・名前・スコア）
  - [x] カジノ風デザイン統一
  - [x] ホーム画面への遷移機能
  - [x] 1位プレイヤーの特別強調表示

---

## 📊 **現在の進捗状況**

### **フェーズ1実装進捗**: 🎉 **100%完了** 🎉

#### ✅ **完了済み（9/9）**
1. 山札残り枚数表示
2. 5秒カウントダウンシステム  
3. ターン管理システム
4. **基本的なカード出し判定システム**
5. **どてんこ宣言システム**
6. **リベンジシステム**
7. **中間結果画面**
8. **🤖 BOT思考システム**
9. **🏆 最終結果画面** ← **✅ 新規実装完了**

---

## 🎯 **BOT実装の詳細仕様**

### **BOT思考システム仕様（@rules準拠）**
- **思考時間**: 最大3秒、最小0.5秒
- **判定精度**: 見逃しなし（初期段階）
- **思考ロジック**: 基本的なロジック
- **対応人数**: 2-5人対応すべて実装

### **BOT行動パターン**
1. **カード出し判定**: 同じ数字優先
2. **デッキから引く判定**: ランダム
3. **パス判定**: ランダム
4. **どてんこ宣言**: 見逃しなし
5. **リベンジ宣言**: 条件満たせば必ず宣言

## 実装計画

### 段階的実装順序（確定）
1. **基本的なカード出し判定システム**
2. **どてんこ宣言システム**
3. **リベンジシステム**（段階的実装可能）
4. **チャレンジゾーンシステム**
5. **しょてんこ・バーストシステム**
6. **スコア計算システム**
7. **中間結果画面**
8. **BOT思考システム**

### 重要な実装ポイント
- ジョーカーの複数パターン計算（独立して-1/0/1選択）
- リアルタイムでのどてんこ宣言（ターン外でも可能）
- 早い者勝ちシステムの実装（ロック機構）
- 場と手札の合計値判定
- 手札7枚でパス時の即座ラウンド終了

### データ管理方針
- **BOT対戦**: 中断・再開なし、プレイ履歴なし
- **オンライン対戦**: BOT代走システム（将来実装）
- **エラー処理**: クラッシュ復旧・状態リセット機能なし

### BOT仕様（フェーズ1確定）
- **思考時間**: トータル3秒、人間らしい遅延あり
- **判定精度**: 見逃しなし（初期段階）
- **カード出し判定**: 同じ数字優先
- **デッキから引く判定**: ランダム
- **パス判定**: ランダム
- **対応人数**: 2-5人対応すべて実装

### UI/UX仕様（フェーズ1確定）
- **ターン表示**: プレイヤーアイコンの背景色を明るくする
- **手札枚数表示**: アイコンの上に数字のみ（実装済み）
- **山札残り枚数**: デッキの上に数字のみ（要実装）
- **プレイヤー配置**: 5人対応必須（実装済み）

### 演出仕様（フェーズ1確定）
- **どてんこ演出**: パチンコの当たりのようにDOTENKOの文字が派手に動く（アニメーション付き）
- **特殊カード演出**: 1,2,ジョーカー同じ / 黒3,ダイヤ3個別（簡単なエフェクト）
- **上昇レート演出**: 豪華な上昇アニメーション
- **音響効果**: あり
- **演出時間**: MAX5秒
- **実装順序**: 指定なし

## タスク管理の方法

### タスクのステータス管理
- [ ] 未着手
- [x] 完了
- [~] 進行中
- [!] 問題あり・緊急

### 優先順位付け
- 🔴 緊急（バグ修正、クリティカル問題）
- 🟡 重要（機能改善、UI/UX向上）
- 🟢 通常（新機能実装）
- ⚪ 低優先（将来の拡張）

## 開発フロー

1. **機能実装後の必須確認事項**
   - コードレビュー
   - テスト実行
   - パフォーマンス確認
   - このTODOファイルの更新

2. **定期的な見直し**
   - 週次: 進捗確認とブロッカー特定
   - 月次: 優先度再評価と計画調整

3. **品質管理**
   - lintエラーの修正
   - メモリリーク検査
   - クラッシュレポート確認

## 重要事項

⚠️ **必ず守ること**
1. 機能実装後は必ずこのファイルを更新
2. バグ発見時は即座に🔴緊急タスクとして記録
3. 新機能追加時は依存関係を明記
4. パフォーマンスに影響する変更は事前レビュー必須
5. リベンジシステムは段階的実装可能だが必須機能
6. 実装済み内容は事前確認してから質問・実装する

---
*最終更新: 2024年12月* 