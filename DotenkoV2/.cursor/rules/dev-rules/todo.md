# DotenkoV2 - タスク管理

## 現在の開発状況（2024年12月）

### 🔴 高優先度タスク

#### ゲーム機能実装（段階的実装）
- [ ] **カード出し判定システム**
  - [ ] 同じ数字判定
  - [ ] 同じスート判定（最初のカードが場と同じスート必須）
  - [ ] 合計値判定（スート関係なし）
  - [ ] 複数カード組み合わせ判定
  - [ ] 不正操作時のアラート表示

- [ ] **ジョーカーシステム**
  - [ ] ジョーカー選択機能（0-4枚）
  - [ ] ジョーカーの数値計算（-1, 0, 1）
  - [ ] 複数ジョーカーの独立計算
  - [ ] 全スート対応機能
  - [ ] 手札合計値計算（複数パターン対応）

- [ ] **どてんこ宣言システム**
  - [ ] 場のカードと手札の合計値判定
  - [ ] どてんこ宣言UI（条件満たす時のみ表示）
  - [ ] 勝敗判定システム
  - [ ] リアルタイム宣言機能（ターン外でも可能）

- [ ] **リベンジシステム（段階的実装）**
  - [ ] どてんこ後の追加判定
  - [ ] リベンジ宣言UI
  - [ ] 複数リベンジ対応
  - [ ] 勝敗の動的変更処理

#### ゲーム進行システム
- [ ] **ゲーム開始フロー**
  - [ ] カード配布（各プレイヤー2枚）
  - [ ] 5秒カウントダウン機能
  - [ ] 山札めくり（早い者勝ち）
  - [ ] ターン管理（時計回り）

- [ ] **プレイヤーターンシステム**
  - [ ] カード出し判定
  - [ ] デッキからカード引く機能
  - [ ] パス機能
  - [ ] 手札上限管理（7枚）
  - [ ] 負け判定（手札7枚でパス→ラウンド終了）

- [ ] **山札管理システム**
  - [ ] 山札切れ時のシャッフル（場の一番上を残す）
  - [ ] デッキサイクル管理
  - [ ] ラウンド終了時の全カード回収・シャッフル

#### スコア計算システム
- [ ] **レート計算機能**
  - [ ] 初期レート設定（GameSetting.gameRate）
  - [ ] 上昇レート計算（連続カード、特殊カード対応）
  - [ ] デッキの裏の数字取得（山札の一番下）
  - [ ] 最終スコア計算（初期×上昇×裏数字）

- [ ] **上昇レート倍増システム**
  - [ ] ゲーム開始時：1、2、ジョーカー判定（連続確認）
  - [ ] ゲーム中：同じ数字連続判定（GameSetting.upRate）
  - [ ] ゲーム終了時：デッキ裏の1、2、ジョーカー判定（連続確認）
  - [ ] 連続倍増処理

#### BOTシステム
- [ ] **BOT思考システム**
  - [ ] 思考時間設定（最大3秒、最小0.5秒）
  - [ ] カード出し判定AI（同じ数字優先）
  - [ ] デッキから引く判定（ランダム）
  - [ ] パス判定（ランダム）
  - [ ] どてんこ宣言判定AI（見逃しなし）
  - [ ] リベンジ宣言判定AI

### 🟡 中優先度タスク

#### UI/UX実装
- [ ] **ゲーム画面UI**
  - [ ] 場のカード表示
  - [ ] 手札表示（2枚初期、最大7枚）
  - [ ] カード選択UI（Y軸移動表示）
  - [ ] カード出しボタン
  - [ ] どてんこ宣言専用ボタン
  - [ ] スコア表示

- [ ] **プレイヤー配置システム**
  - [ ] 2人：上、対面
  - [ ] 3人：左右
  - [ ] 4人：上、左右
  - [ ] 5人：上2人、左右（重ならない間隔調整）

- [ ] **中間結果画面**
  - [ ] 現在の所持スコア表示
  - [ ] ラウンドでの移動スコア表示
  - [ ] OKボタン（全員待機システム）
  - [ ] 次ラウンドへの遷移

- [ ] **勝敗表示システム**
  - [ ] プレイヤーアイコンの枠変化
  - [ ] 勝者・敗者の文字表示
  - [ ] どてんこ/リベンジ成功演出

#### 演出システム
- [ ] **カジノ風演出**
  - [ ] 上昇レート倍増演出（豪華）
  - [ ] どてんこ宣言エフェクト（パチンコ風）
  - [ ] リベンジ宣言エフェクト
  - [ ] 勝利演出
  - [ ] 音響効果（MAX5秒）

#### 早い者勝ちシステム
- [ ] **ロック機構実装**
  - [ ] 同時操作の優先順位判定
  - [ ] キューロジック
  - [ ] タイムスタンプ管理
  - [ ] 複数プレイヤー同時操作対応

#### ターン表示システム
- [ ] **背景色変更実装**
  - [ ] ターンプレイヤーの背景を明るくする
  - [ ] 非ターンプレイヤーの背景を通常に戻す

#### 山札残り枚数表示
- [ ] **DeckView更新**
  - [ ] デッキの上に数字のみで表示
  - [ ] 残り枚数の動的更新

### 🟢 低優先度タスク

#### チャレンジゾーンシステム（フェーズ1）
- [ ] **チャレンジゾーン発生条件**
  - [ ] 全プレイヤーのどてんこ宣言完了判定
  - [ ] 参加条件判定（手札合計 < 場のカード数字）

- [ ] **チャレンジゾーン進行**
  - [ ] どてんこした次の人から時計回り
  - [ ] 手札無制限システム
  - [ ] ジョーカー自動選択（どてんこ最適化）
  - [ ] 山札切れ時の場カードシャッフル

- [ ] **チャレンジゾーン終了**
  - [ ] 終了条件判定（全員手札合計 > 場の数字）
  - [ ] 最終勝者・敗者決定

#### しょてんこ・バーストシステム（フェーズ1）
- [ ] **しょてんこ（SHOTENKO）**
  - [ ] 最初のカードと手札合計一致判定
  - [ ] 勝者1人 vs 敗者全員のスコア計算
  - [ ] チャレンジゾーン発生処理

- [ ] **バースト（Burst）**
  - [ ] 手札7枚でパス判定
  - [ ] 敗者1人 vs 勝者全員のスコア計算
  - [ ] チャレンジゾーンスキップ処理

#### スコア確定イベント（フェーズ1）
- [ ] **デッキの裏確認**
  - [ ] 山札の一番下カード確認演出
  - [ ] 特殊カード連続確認処理
  - [ ] 特殊カード効果適用

- [ ] **特殊カード演出**
  - [ ] 1、2、ジョーカー演出（同じ）
  - [ ] 黒3演出（個別）
  - [ ] ダイヤ3演出（個別）

#### オンライン対戦システム（将来実装）
- [ ] **友人対戦機能**
  - [ ] 友人招待システム
  - [ ] ルーム作成・参加
  - [ ] リアルタイム同期

- [ ] **BOT代走システム**
  - [ ] 切断検知機能
  - [ ] BOT自動代理操作
  - [ ] 復帰時の操作権移譲
  - [ ] 状態同期機能

- [ ] **ネットワーク管理**
  - [ ] 自動再接続機能
  - [ ] 切断時の状態保存
  - [ ] ゲーム中断・再開機能
  - [ ] エラー回復処理

#### 追加機能
- [ ] **設定機能拡張**
  - [ ] 音響設定
  - [ ] 演出設定

- [ ] **チュートリアル**
  - [ ] ゲームルール説明
  - [ ] 操作方法説明

### ✅ 完了済みタスク

- [x] **プロジェクト初期化**
  - [x] SwiftUI + MVVM アーキテクチャ構築
  - [x] Firebase統合
  - [x] 基本画面構成

- [x] **GameSetting実装**
  - [x] roundCount（ラウンド数）: デフォルト "5"
  - [x] jokerCount（ジョーカー枚数）: デフォルト "2"
  - [x] gameRate（ゲームレート）: デフォルト "1"
  - [x] upRate（重ねレートアップ）: デフォルト "3"
  - [x] maxScore（スコア上限）: デフォルト "1000"
  - [x] deckCycle（デッキサイクル）: デフォルト "3"

- [x] **UI基本実装**
  - [x] 手札枚数表示（アイコンの上に数字のみ）
  - [x] カード選択解除機能（再タップ）
  - [x] プレイヤー配置システム（2-5人対応）

- [x] **エラー処理基本実装**
  - [x] ネットワークエラー処理（3回リトライ後エラー画面）
  - [x] アプリ復帰時のゲーム状態継続

- [x] **設計決定**
  - [x] ゲームルール確定
  - [x] 技術スタック決定
  - [x] UI/UX方針決定
  - [x] プレイヤー配置パターン確定

## 実装計画

### 段階的実装順序（確定）
1. **基本的なカード出し判定システム**
2. **どてんこ宣言システム**
3. **リベンジシステム**（段階的実装可能）
4. **チャレンジゾーンシステム**
5. **しょてんこ・バーストシステム**
6. **スコア計算システム**
7. **中間結果画面**
8. **BOT思考システム**

### 重要な実装ポイント
- ジョーカーの複数パターン計算（独立して-1/0/1選択）
- リアルタイムでのどてんこ宣言（ターン外でも可能）
- 早い者勝ちシステムの実装（ロック機構）
- 場と手札の合計値判定
- 手札7枚でパス時の即座ラウンド終了

### データ管理方針
- **BOT対戦**: 中断・再開なし、プレイ履歴なし
- **オンライン対戦**: BOT代走システム（将来実装）
- **エラー処理**: クラッシュ復旧・状態リセット機能なし

### BOT仕様（フェーズ1確定）
- **思考時間**: トータル3秒、人間らしい遅延あり
- **判定精度**: 見逃しなし（初期段階）
- **カード出し判定**: 同じ数字優先
- **デッキから引く判定**: ランダム
- **パス判定**: ランダム
- **対応人数**: 2-5人対応すべて実装

### UI/UX仕様（フェーズ1確定）
- **ターン表示**: プレイヤーアイコンの背景色を明るくする
- **手札枚数表示**: アイコンの上に数字のみ（実装済み）
- **山札残り枚数**: デッキの上に数字のみ（要実装）
- **プレイヤー配置**: 5人対応必須（実装済み）

### 演出仕様（フェーズ1確定）
- **どてんこ演出**: パチンコの当たりのようにDOTENKOの文字が派手に動く（アニメーション付き）
- **特殊カード演出**: 1,2,ジョーカー同じ / 黒3,ダイヤ3個別（簡単なエフェクト）
- **上昇レート演出**: 豪華な上昇アニメーション
- **音響効果**: あり
- **演出時間**: MAX5秒
- **実装順序**: 指定なし

## タスク管理の方法

### タスクのステータス管理
- [ ] 未着手
- [x] 完了
- [~] 進行中
- [!] 問題あり・緊急

### 優先順位付け
- 🔴 緊急（バグ修正、クリティカル問題）
- 🟡 重要（機能改善、UI/UX向上）
- 🟢 通常（新機能実装）
- ⚪ 低優先（将来の拡張）

## 開発フロー

1. **機能実装後の必須確認事項**
   - コードレビュー
   - テスト実行
   - パフォーマンス確認
   - このTODOファイルの更新

2. **定期的な見直し**
   - 週次: 進捗確認とブロッカー特定
   - 月次: 優先度再評価と計画調整

3. **品質管理**
   - lintエラーの修正
   - メモリリーク検査
   - クラッシュレポート確認

## 重要事項

⚠️ **必ず守ること**
1. 機能実装後は必ずこのファイルを更新
2. バグ発見時は即座に🔴緊急タスクとして記録
3. 新機能追加時は依存関係を明記
4. パフォーマンスに影響する変更は事前レビュー必須
5. リベンジシステムは段階的実装可能だが必須機能
6. 実装済み内容は事前確認してから質問・実装する

---
*最終更新: 2024年12月* 