# DotenkoV2 - ゲームロジック要件すり合わせドキュメント

**作成日**: 2024年12月  
**目的**: どてんこ、しょてんこ、リベンジ、チャレンジゾーンのロジックや構成について、現在の実装と期待される要件の差異を特定し、要件をすり合わせる

---

## 📊 現在の実装状況

### 🎯 どてんこシステム

#### ✅ 実装済み機能
- **基本判定**: 場のカードと手札合計の一致判定
→場の一番上のカードと手札の合計の一致です
- **リアルタイム宣言**: ターン外でも宣言可能（早い者勝ち）
- **UI制御**: 条件満たす時のみボタン表示
- **BOT対応**: 見逃しなしで自動宣言
- **勝敗設定**: どてんこした人が勝者、場のカードを出した人が敗者
→どてんこされたカードを出した人が敗者です。すなわち、自分の出したカードに対してどてんこはできないです

#### 🔍 実装詳細
```swift
// GameViewModel.swift - handleDotenkoDeclaration()
- 条件チェック: canPlayerDeclareDotenko()
- 状態更新: players[playerIndex].dtnk = true
- 勝者設定: revengeManager.setDotenkoWinnerId(playerId)
- 次フェーズ: revengeManager.startRevengeWaitingPhase()
```

---

### 🎊 しょてんこシステム

#### ✅ 実装済み機能
- **基本判定**: 最初の場札と手札合計の一致判定
- **自動チェック**: 最初のカード配布後に自動実行
→プレイヤーに対して自動実行はしないでください。
- **勝敗設定**: しょてんこした人 vs その他全員
- **チャレンジゾーン**: しょてんこ後もチャレンジゾーン発生
- **BOT優先**: BOTが条件満たす場合は即座に宣言

#### 🔍 実装詳細
```swift
// GameViewModel.swift - checkShotenkoDeclarations()
- 判定タイミング: isFirstCardDealt && !fieldCards.isEmpty
- 条件チェック: handTotals.contains(fieldValue)
- BOT処理: 即座に宣言
- 人間処理: 3秒間ボタン表示 → 自動宣言
- 勝敗設定: しょてんこした人=勝者、その他=敗者
```

---

### 🔥 リベンジシステム

#### ✅ 実装済み機能
- **発生条件**: どてんこ宣言後、他にも条件を満たすプレイヤーがいる場合
- **待機フェーズ**: 5秒間のリベンジ待機
- **連鎖対応**: 複数回のリベンジ可能
- **勝敗変更**: 最後にリベンジした人が勝者、前の勝者が敗者
- **BOT対応**: 条件満たせば必ず宣言（遅延あり）

#### 🔍 実装詳細
```swift
// GameRevengeManager.swift - startRevengeWaitingPhase()
- 待機時間: revengeCountdown = 5
- 対象特定: updateRevengeEligiblePlayers()
- タイマー: startRevengeTimer()
- BOTチェック: checkBotRevengeDeclarations()
- 連鎖処理: リベンジ後再度5秒待機
```

誰かがどてんこした際に、チャレンジゾーンに参加するかしないかのモーダルを出します。
通常は参加する・しないの２種類のボタンですが
リベンジできる場合は
リベンジボタンと参加しないのボタンになります

リベンジボタン押下したらリベンジアニメーションが流れて勝敗がさらに変わります
そして再度アナウンスモーダルが表示されます
ただこの時点で勝敗に絡んでいるので参加するボタンのみです

---

### 🎯 チャレンジゾーンシステム

#### ✅ 実装済み機能
- **発生条件**: 全プレイヤーのどてんこ宣言完了後
→チャレンジゾーンアナウンスでみんなが応答したら
- **参加条件**: 手札合計 < 場のカード数字
→チャレンじゾーン参加者
- **進行順序**: どてんこした次の人から時計回り
→最後にどてんこした次の人から（どてんこ後に誰かがリベンジしたらそのリベンジした人の次からです）
- **終了条件**: 参加者全員が条件を満たさなくなるまで
- **手札制限**: チャレンジ中は手札無制限
- **ジョーカー**: 自動選択で最適化

#### 🔍 実装詳細
```swift
// GameRevengeManager.swift - startChallengeZone()
- 参加条件: minHandTotal < fieldValue
- 開始位置: (dotenkoWinnerIndex + 1) % players.count
- ターン処理: processChallengeZoneTurn()
- BOT行動: performBotChallengeAction()
- 終了判定: challengeParticipants.isEmpty
```

---

## 🤔 要件すり合わせが必要な項目

### 1. **ゲーム進行の全体フロー**

#### 現在の実装フロー
```
通常ゲーム → どてんこ宣言 → リベンジ待機(5秒) → チャレンジゾーン → スコア計算
                ↓
            しょてんこ宣言 → チャレンジゾーン → スコア計算
                ↓
            バースト発生 → スコア計算（チャレンジゾーンスキップ）
```

#### 🔍 確認ポイント
- この進行フローは期待通りですか？
→違います
- しょてんこ後のチャレンジゾーン発生は正しいですか？
→正しい
- バーストでのチャレンジゾーンスキップは正しいですか？
→正しい
---

### 2. **どてんこ宣言の詳細仕様**

#### 現在の実装
- **宣言タイミング**: リアルタイム（ターン関係なくいつでも）
- **複数同時**: 早い者勝ち
- **勝敗**: どてんこした人 vs 場のカードを出した人
- **UI**: 条件満たす瞬間にボタン表示

#### 🔍 確認ポイント
1. **宣言タイミング制限**はありますか？（例：自分のターンのみ、カード出し直後のみ等）
→なし
2. **複数同時宣言**の処理は早い者勝ちで良いですか？
→はい、ただ最後にどてんこした人が勝ちです
3. **勝敗判定**「どてんこした人 vs 場のカードを出した人」は正しいですか？
4. **UI表示タイミング**は現在の実装で適切ですか？

---

### 3. **しょてんこ宣言の詳細仕様**

#### 現在の実装
- **判定タイミング**: 最初のカード配布直後に自動チェック
- **宣言方法**: BOTは即座、人間は3秒後自動宣言
- **勝敗**: しょてんこした人 vs その他全員
- **後続処理**: チャレンジゾーン発生

#### 🔍 確認ポイント
1. **自動判定**で良いですか？手動宣言が必要ですか？
2. **判定タイミング**は最初のカード配布直後で正しいですか？
3. **人間プレイヤー**の3秒自動宣言は適切ですか？
4. **しょてんこ後のチャレンジゾーン**は必要ですか？

---

### 4. **リベンジシステムの詳細仕様**

#### 現在の実装
- **発生条件**: どてんこ宣言後、他にも条件を満たすプレイヤーがいる場合
- **待機時間**: 5秒間
- **宣言方法**: 専用リベンジボタン
- **連鎖**: 無制限に連鎖可能
- **勝敗変更**: 最後にリベンジした人が勝者

#### 🔍 確認ポイント
1. **発生条件**「他にも条件を満たすプレイヤーがいる場合」は正しいですか？
2. **待機時間**5秒は適切ですか？
3. **宣言方法**は専用ボタンで良いですか？
4. **連鎖制限**は必要ですか？（例：1回まで、2回まで等）
5. **勝敗変更**のロジックは正しいですか？

---

### 5. **チャレンジゾーンの詳細仕様**

#### 現在の実装
- **発生タイミング**: リベンジ待機終了後
- **参加条件**: 手札合計 < 場のカード数字
- **進行順序**: どてんこした次の人から時計回り
- **手札制限**: 無制限
- **終了条件**: 参加者全員が条件を満たさなくなるまで

#### 🔍 確認ポイント
1. **発生タイミング**はリベンジ待機終了後で正しいですか？
2. **参加条件**「手札合計 < 場のカード数字」は正しいですか？
3. **進行順序**「どてんこした次の人から時計回り」は正しいですか？
4. **手札制限**は無制限で良いですか？
5. **終了条件**の判定は適切ですか？
6. **ジョーカーの自動選択**は正しいですか？

---

## 🎮 具体的な動作例での確認

### ケース1: 通常のどてんこ
```
1. プレイヤーAがカードを出す（場: 7）
2. プレイヤーBの手札合計が7 → どてんこ宣言
3. リベンジ待機開始（5秒）
4. 他プレイヤーもどてんこ条件を満たす場合 → リベンジ可能
5. チャレンジゾーン開始
6. スコア計算
```

### ケース2: しょてんこ
```
1. 最初のカード配布（場: 5）
2. プレイヤーCの手札合計が5 → しょてんこ自動判定
3. チャレンジゾーン開始
4. スコア計算
```

### ケース3: リベンジ連鎖
```
1. プレイヤーAがどてんこ宣言
2. リベンジ待機中にプレイヤーBがリベンジ宣言
3. 再度リベンジ待機開始
4. プレイヤーCがさらにリベンジ宣言
5. チャレンジゾーン開始
```

---

## 📝 チェック項目一覧

### 基本動作
- [ ] どてんこ宣言のタイミング制限
- [ ] しょてんこの自動/手動判定
- [ ] リベンジの発生条件
- [ ] チャレンジゾーンの参加条件
- [ ] ゲーム進行の全体フロー

### UI/UX
- [ ] ボタン表示タイミング
- [ ] 待機時間の長さ
- [ ] アナウンス表示
- [ ] プレイヤー操作の制限

### 勝敗判定
- [ ] どてんこの勝敗設定
- [ ] しょてんこの勝敗設定
- [ ] リベンジでの勝敗変更
- [ ] チャレンジゾーンでの勝敗変更

### 特殊ケース
- [ ] 複数同時宣言の処理
- [ ] 連鎖リベンジの制限
- [ ] バーストでのチャレンジゾーンスキップ
- [ ] ジョーカーの扱い

---

## 🔧 修正が必要になる可能性のあるファイル

### ゲームロジック
- `ViewModel/GameViewModel.swift` - メインゲームロジック
- `ViewModel/GameRevengeManager.swift` - リベンジ・チャレンジゾーン管理
- `ViewModel/BotManager.swift` - BOT行動制御

### UI制御
- `View/Game/GamePlayersAreaView.swift` - プレイヤーエリア表示
- `View/Components/ButtonView/DotenkoDeclarationButton.swift` - 宣言ボタン

### データモデル
- `Model/Game/GameType.swift` - ゲームフェーズ定義
- `Model/Game/PlayerModel.swift` - プレイヤー状態

---

## ❓ **追加質問事項**

### 質問1: ゲーム進行フローについて
現在の実装フローが「違います」とのことですが、正しいフローを教えてください。

**例**: 
```
現在: どてんこ宣言 → リベンジ待機(5秒) → チャレンジゾーン → スコア計算

期待: どてんこ宣言 → チャレンジゾーン参加モーダル → 勝者以外にチャレンジする人がいればチャレンジゾーン　→ チャレンジゾーン　→ スコア計算
チャレンジゾーンではみんな手札を表にします
```

**具体的な例**:
- プレイヤーAがカード7を出す
- プレイヤーBがどてんこ宣言
- この後の流れはどうなりますか？

1. 即座にチャレンジゾーン参加モーダルが表示される？
→どてんこのアニメーションが流れて参加モーダル表示されます
2. リベンジ待機時間はなくなる？
→そうですね
3. モーダルで全員が応答したらチャレンジゾーン開始？
→はい

### 質問2: チャレンジゾーン参加モーダルの詳細
「誰かがどてんこした際に、チャレンジゾーンに参加するかしないかのモーダルを出します」とありますが：

**例**: プレイヤーA、B、C、Dの4人ゲームで、プレイヤーBがどてんこした場合
- モーダルは誰に表示されますか？（A、C、D全員？）
→全員です
- BOTプレイヤーはどう判断しますか？
→問答無用で参加してください
- 全員が応答するまで待機しますか？
→はい

### 質問3: リベンジボタンの表示条件
「リベンジできる場合はリベンジボタンと参加しないのボタンになります」とありますが：

**例**: プレイヤーBがどてんこ、プレイヤーCもどてんこ条件を満たす場合
- プレイヤーCのモーダルには「リベンジ」「参加しない」が表示される？
→Cがどてんこ・リベンジ可能なのであればそうです
- プレイヤーA、Dには「参加する」「参加しない」が表示される？
→はい
- リベンジ可能な複数プレイヤーがいる場合はどうなりますか？
→どうとは？

### 質問4: リベンジ後の処理
「リベンジボタン押下したらリベンジアニメーションが流れて勝敗がさらに変わります。そして再度アナウンスモーダルが表示されます」とありますが：

**例**: プレイヤーBがどてんこ → プレイヤーCがリベンジした場合
- リベンジアニメーション後、再度全員にモーダル表示？
→はい、そうですね。
- この時プレイヤーCは「勝敗に絡んでいるので参加するボタンのみ」？
→はい、勝敗に絡んでいる人は参加ボタンのみです
- 他のプレイヤー（A、D）はどんなボタンが表示されますか？
→参加する　しない

### 質問5: しょてんこの手動宣言
「プレイヤーに対して自動実行はしないでください」とありますが：

**例**: 最初のカードが5、プレイヤーの手札合計も5の場合
- しょてんこボタンが表示される？
- 時間制限はありますか？
- 宣言しなかった場合はどうなりますか？
しょてんこはデッキから出されたカードにのみ有効です。誰かが場にカードを出した時点でしょてんこ→どてんこになります

### 質問6: 自分のカードに対するどてんこ制限
「自分の出したカードに対してどてんこはできないです」とありますが：

**例**: プレイヤーAがカード7を出し、プレイヤーAの手札合計も7の場合
- どてんこボタンは表示されない？
→そうですね。
- この制限は現在の実装にありますか？
→ないんじゃないですか

### 質問7: リベンジ可能な複数プレイヤーについて
「リベンジ可能な複数プレイヤーがいる場合はどうなりますか？→どうとは？」とありましたが：

**例**: プレイヤーBがどてんこ、プレイヤーCとDの両方がリベンジ可能な場合
- CとD両方のモーダルに「リベンジ」ボタンが表示される？
→はいそうです
- 両方がリベンジボタンを押した場合、どちらが優先される？（早い者勝ち？）
→はい、先に押した人が適応されリベンジアニメーションが走ります
- 片方がリベンジ、もう片方が参加しないを選んだ場合の処理は？
→リベンジアニメーションが走り再度参加可否もーだるになります

### 質問8: チャレンジゾーンでの手札公開について
「チャレンジゾーンではみんな手札を表にします」とありますが：

**例**: チャレンジゾーン開始時
- 参加者のみ手札公開？それとも全プレイヤー？
→参加者のみ公開します
- 手札公開のタイミングはチャレンジゾーン開始時？
→そうです
- 公開後もカードを引いて手札が増えた場合、それも公開される？
→そうです

### 質問9: しょてんこの詳細について
「しょてんこはデッキから出されたカードにのみ有効です。誰かが場にカードを出した時点でしょてんこ→どてんこになります」とありますが：

**例**: ゲーム開始時にデッキから5が出て、プレイヤーの手札合計も5の場合
- しょてんこボタンが表示される？
→はい
- その後、誰かがカードを出すまでしょてんこ宣言可能？
→はい
- 誰かがカードを出した瞬間にしょてんこボタンは消える？
→はいそうです

---

**このドキュメントをチェックして、修正が必要な項目をお知らせください。** 