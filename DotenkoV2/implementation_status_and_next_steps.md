# DotenkoV2 - 実装状況確認と今後のステップ

**作成日**: 2024年12月  
**目的**: 要件すり合わせ後の現在の実装状況を確認し、今後の修正ステップを明確化する

---

## 📊 現在の実装状況

### 🎯 どてんこシステム

#### ✅ 実装済み機能
- **基本判定**: 場の一番上のカードと手札合計の一致判定 ✅
- **リアルタイム宣言**: ターン外でも宣言可能（早い者勝ち） ✅
- **UI制御**: 条件満たす時のみボタン表示 ✅
- **BOT対応**: 見逃しなしで自動宣言 ✅
- **勝敗設定**: どてんこした人が勝者、場のカードを出した人が敗者 ✅

#### ❌ 未実装・修正必要
- **自分のカード制限**: 自分が出したカードにはどてんこ不可 ❌
- **複数同時宣言**: 最後にどてんこした人が勝ち（現在は早い者勝ち） ❌

### 🎊 しょてんこシステム

#### ✅ 実装済み機能
- **基本判定**: 最初の場札と手札合計の一致判定 ✅
- **勝敗設定**: しょてんこした人 vs その他全員 ✅
- **チャレンジゾーン**: しょてんこ後もチャレンジゾーン発生 ✅
- **BOT対応**: BOTが条件満たす場合は即座に宣言 ✅

#### ❌ 未実装・修正必要
- **手動宣言**: プレイヤーに対して自動実行しない（手動宣言のみ） ❌
- **デッキ限定**: デッキから出されたカードにのみ有効 ✅（実装済み）
- **ボタン切り替え**: カード出し後にしょてんこ→どてんこボタンに変化 ❌

### 🔥 リベンジシステム

#### ✅ 実装済み機能
- **発生条件**: どてんこ宣言後、他にも条件を満たすプレイヤーがいる場合 ✅
- **連鎖対応**: 複数回のリベンジ可能 ✅
- **勝敗変更**: 最後にリベンジした人が勝者、前の勝者が敗者 ✅
- **BOT対応**: 条件満たせば必ず宣言 ✅

#### ❌ 未実装・修正必要
- **待機時間廃止**: 5秒待機を廃止し、即座にモーダル表示 ❌
- **参加モーダル**: チャレンジゾーン参加可否モーダルの実装 ❌
- **複数リベンジ**: 早い者勝ち処理（現在は遅延処理） ❌

### 🎯 チャレンジゾーンシステム

#### ✅ 実装済み機能
- **発生条件**: 全プレイヤーのどてんこ宣言完了後 ✅
- **参加条件**: 手札合計 < 場のカード数字 ✅
- **進行順序**: どてんこした次の人から時計回り ✅
- **終了条件**: 参加者全員が条件を満たさなくなるまで ✅
- **手札制限**: チャレンジ中は手札無制限 ✅

#### ❌ 未実装・修正必要
- **参加モーダル**: 参加可否選択モーダル ❌
- **手札公開**: チャレンジゾーン参加者の手札公開 ❌
- **BOT応答遅延**: 1-3秒の応答遅延 ❌

### ✅ **Phase 1（基本ロジック修正）: 100%完了**

1. **自分のカード制限追加** ✅
   - `lastCardPlayerId`プロパティで最後にカードを出したプレイヤーを追跡
   - `canPlayerDeclareDotenko()`で自分が出したカードへのどてんこ制限を実装

2. **しょてんこ自動実行廃止** ✅
   - プレイヤーの自動宣言を削除、手動宣言のみに変更
   - BOTは引き続き自動宣言

3. **複数同時宣言処理修正** ✅
   - `dotenkoDeclarationTimestamps`でタイムスタンプ管理
   - 最後の宣言者が勝者になるよう修正

4. **リベンジ待機時間廃止** ✅
   - 5秒待機を廃止し、即座にチャレンジゾーン参加モーダル表示

### ✅ **Phase 2（UI/UX実装）: 100%完了**

5. **チャレンジゾーン参加モーダル実装** ✅
   - `ChallengeZoneParticipationModal.swift`完全実装
   - 参加する/参加しない/リベンジボタン
   - タイムアウト5秒、BOT自動選択
   - レスポンシブ対応、UI調整完了

6. **宣言アニメーション実装** ✅
   - **TOP画面ロゴアニメーション使用** ✅
   - `DotenkoLogoAnimationView.swift`新規作成 ✅
   - どてんこ・しょてんこ・リベンジ宣言アニメーション ✅
   - 斜めから迫ってくる → 巨大バウンス → 落ち着く → グロー効果 ✅
   - 背景カードアニメーション付き ✅
   - `GameAnnouncementEffectManager`で統一管理 ✅
   - アニメーション中の操作無効化 ✅

7. **手札公開機能実装** ✅
   - 既存PlayerIconViewシステム活用 ✅
   - shouldShowCardFrontロジック拡張 ✅
   - チャレンジゾーン参加者の手札自動表示 ✅
   - GameRevengeManagerに状態管理追加 ✅
   - 専用UIコンポーネント不要（シンプル化） ✅

8. **全プレイヤー処理停止機能実装** ✅
   - どてんこ宣言時に全プレイヤーの処理を停止 ✅
   - `stopAllPlayerActions()`メソッド実装 ✅
   - BOT処理停止（`GameBotManager.stopAllBotActions()`） ✅
   - プレイヤー操作無効化（`isAnnouncementBlocking`フラグ） ✅
   - しょてんこ・リベンジ宣言時も同様に処理停止 ✅

---

## 🚀 今後の修正ステップ

### Phase 1: 基本ロジック修正（優先度：高）

#### 1.1 どてんこシステム修正
- [ ] **自分のカード制限追加**
  - `GameViewModel.canPlayerDeclareDotenko()` に制限ロジック追加
  - 最後に場にカードを出したプレイヤーIDを追跡
  - 自分が出したカードの場合はfalseを返す

- [ ] **複数同時宣言処理修正**
  - 早い者勝ちから最後の宣言者勝ちに変更
  - タイムスタンプベースの処理に修正

#### 1.2 しょてんこシステム修正
- [ ] **プレイヤー自動実行廃止**
  - `checkShotenkoDeclarations()` でプレイヤーの自動宣言を削除
  - 手動宣言のみに変更

- [ ] **ボタン切り替え実装**
  - カード出し後にしょてんこボタンを非表示
  - どてんこ条件を満たす場合はどてんこボタン表示

#### 1.3 リベンジシステム修正
- [ ] **待機時間廃止**
  - `startRevengeWaitingPhase()` の5秒タイマーを削除
  - 即座にモーダル表示に変更

### Phase 2: UI/UX実装（優先度：高）

#### 2.1 チャレンジゾーン参加モーダル実装
- [x] **モーダルコンポーネント作成**
  - `ChallengeZoneParticipationModal.swift` 作成 ✅
  - 参加する/参加しない/リベンジボタン ✅
  - タイムアウト5秒、デフォルト「参加する」 ✅

- [x] **モーダル表示ロジック**
  - どてんこアニメーション後に表示 ✅
  - 全プレイヤーに表示（条件別ボタン） ✅
  - BOT応答処理（1-3秒遅延） ✅

#### 2.2 手札公開機能実装
- [x] **手札公開UI**
  - チャレンジゾーン参加者のみ公開 ✅
  - 既存PlayerIconViewの手札表示システム活用 ✅
  - shouldShowCardFrontロジック拡張 ✅
  - 専用UIコンポーネント不要（シンプル化） ✅
  - 既存CardViewコンポーネント活用 ✅

### Phase 3: 詳細調整（優先度：中）

#### 3.1 BOT行動調整
- [ ] **リベンジ優先処理**
  - リベンジ可能時は必ず「リベンジ」選択
  - 通常時は「参加する」選択

- [ ] **応答遅延実装**
  - 1-3秒のランダム遅延
  - 人間らしい応答タイミング

#### 3.2 エラーハンドリング強化
- [ ] **参加条件チェック**
  - 条件を満たさないプレイヤーの処理
  - 「参加しない」ボタンのみ表示

- [ ] **チャレンジゾーン中の制限**
  - チャレンジゾーン中はリベンジ不可
  - 適切なボタン制御

---

## 📁 修正対象ファイル

### 主要ファイル
1. **`ViewModel/GameViewModel.swift`**
   - どてんこ判定ロジック修正 ✅
   - しょてんこ自動実行廃止 ✅
   - 最後にカードを出したプレイヤー追跡 ✅
   - 全プレイヤー処理停止機能追加 ✅

2. **`ViewModel/GameRevengeManager.swift`**
   - リベンジ待機時間廃止 ✅
   - モーダル表示ロジック追加 ✅
   - 複数リベンジ早い者勝ち処理 ✅
   - リベンジ宣言時の処理停止追加 ✅

3. **`ViewModel/GameAnnouncementEffectManager.swift`**
   - 宣言アニメーション統合 ✅
   - どてんこロゴアニメーションシステム追加 ✅
   - TOP画面ロゴアニメーション使用 ✅

4. **`ViewModel/GameBotManager.swift`**
   - BOT処理停止機能追加 ✅
   - BOT応答遅延実装（将来実装）

5. **`ViewModel/BotManager.swift`**
   - BOT応答遅延実装（将来実装）
   - リベンジ優先処理（将来実装）

### 新規作成ファイル
4. **`View/Components/Modal/ChallengeZoneParticipationModal.swift`**
   - チャレンジゾーン参加モーダル ✅

5. **`View/Components/DotenkoLogoAnimationView.swift`**
   - TOP画面ロゴアニメーション使用の宣言アニメーション ✅
   - 斜めから迫ってくる → 巨大バウンス → 落ち着く → グロー効果 ✅
   - 背景カードアニメーション付き ✅

6. **`View/Components/HandRevealView.swift`**
   - ~~手札公開表示コンポーネント~~ 削除済み（既存システム活用のため不要） ✅

### UI調整ファイル
7. **`View/Game/GamePlayersAreaView.swift`**
   - モーダル表示制御 ✅
   - ~~手札公開表示~~ 削除済み（既存システム活用のため不要） ✅

8. **`View/Game/PlayerIconView.swift`**
   - shouldShowCardFrontロジック拡張 ✅
   - チャレンジゾーン参加者手札表示対応 ✅

9. **`View/Game/GameMainView.swift`**
   - どてんこロゴアニメーション表示統合 ✅

  10. **`View/Components/ButtonView/DotenkoDeclarationButton.swift`**
   - ボタン切り替えロジック

---

## 🎯 実装優先順位

### ✅ 完了済み（Phase 1）
1. 自分のカード制限追加 ✅
2. しょてんこ自動実行廃止 ✅
3. リベンジ待機時間廃止 ✅
4. 複数同時宣言処理修正 ✅

### ✅ 完了済み（Phase 2）
5. チャレンジゾーン参加モーダル実装 ✅
   - UI調整・レスポンシブ対応 ✅
   - 他プレイヤー選択内容非表示 ✅
   - 回答済み状況表示 ✅
6. 宣言アニメーション実装 ✅
   - どてんこ宣言アニメーション ✅
   - しょてんこ宣言アニメーション ✅
   - リベンジ宣言アニメーション ✅
   - アニメーション中の操作無効化 ✅

### ✅ 完了済み（Phase 2 継続）
7. 手札公開機能実装 ✅
   - 既存PlayerIconViewシステム活用 ✅
   - shouldShowCardFrontロジック拡張 ✅
   - チャレンジゾーン参加者の手札自動表示 ✅
   - GameRevengeManagerに状態管理追加 ✅
   - 専用UIコンポーネント不要（シンプル化） ✅

### 🟢 中優先（Phase 3）
8. BOT応答遅延実装
9. ボタン切り替え実装
10. エラーハンドリング強化

---

## 📝 実装完了チェックリスト

### どてんこシステム
- [x] 自分が出したカードにはどてんこ不可 ✅
- [x] 複数同時宣言は最後の人が勝ち ✅
- [x] 早い者勝ち処理の修正 ✅

### しょてんこシステム
- [x] プレイヤーの自動実行廃止 ✅
- [x] 手動宣言のみに変更 ✅
- [ ] カード出し後のボタン切り替え

### リベンジシステム
- [x] 5秒待機時間の廃止 ✅
- [x] 即座にモーダル表示 ✅
- [x] 複数リベンジの早い者勝ち ✅

### チャレンジゾーンシステム
- [x] 参加可否モーダル実装 ✅
- [x] 手札公開機能 ✅
- [ ] BOT応答遅延（1-3秒）

### 全体統合
- [ ] ゲームフロー確認
- [ ] エラーハンドリング
- [ ] UI/UX統一性確認

---

## 🔄 次のアクション

1. **Phase 1の実装開始**
   - 自分のカード制限追加から着手
   - GameViewModelの修正

2. **テスト環境準備**
   - 修正後の動作確認
   - 各シナリオのテストケース作成

3. **段階的リリース**
   - Phase 1完了後に中間確認
   - Phase 2, 3の順次実装

---

*最終更新: 2024年12月* 